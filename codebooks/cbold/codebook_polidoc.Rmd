---
title: "Codebook bundeslaendeR polidoc Link"
author: "Robert Stelzle"
date: "21.01.2022"
output:
  pdf_document:
    keep_tex: true
header-includes:
- \usepackage{longtable}
- \usepackage{float}
- \usepackage{graphicx}
---
  
```{r include=FALSE}
library(tidyverse)
library(bundeslaendeR)
library(kableExtra)
library(patchwork)
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(fig.align="center",
                      fig.width = 5)
```

```{r}
# Design des longtables low key von Werner Krause geklaut

item_start <- function(item_name_code, item_name, item_desc, desc_left = FALSE) {
  item_name_code <- str_replace_all(item_name_code, pattern = r"{_}", replacement = r"{\\_}")
  cat("\\begin{longtable}{p{3.2cm}| p{11cm}}")
  cat("\n")
  cat(paste0("\\texttt{", item_name_code, "} &"))
  cat(paste0("\\textbf{", item_name, "}"))
  cat("\\newline \n")
  
  if (desc_left == FALSE) {
    cat(item_desc)
  }
  if (desc_left == TRUE) {
    cat("\\begin{flushleft}")
    cat(item_desc)
    cat("\n")
    cat("\\end{flushleft}")
    cat("\n")
  }
  
}


item_image <- function(ggobj, filenameimg, width, height) {
  
  ggsave(ggobj, filename = filenameimg, width = width, height = height)
  
  cat("\\hspace*{.25cm}")
  cat("\n")
  cat("\\begin{minipage}[t]{\\linewidth }")
  cat("\n")
  cat("\\vspace{0pt}")
  cat("\n")
  cat("\\includegraphics[width = \\linewidth]{")
  cat(filenameimg)
  cat("}")
  cat("\n")
  cat("\\end{minipage}")
  
}


item_end <- function(add_desc = "") {
  cat(add_desc)
  cat("\n")
  cat("\\end{longtable}")
  
}



short_item <- function(item_name_code, item_name, item_desc, desc_left = FALSE) {
  
  item_name_code <- str_replace_all(item_name_code, pattern = r"{_}", replacement = r"{\\_}")
  cat("\\begin{longtable}{p{3.2cm}| p{11cm}}")
  cat("\n")
  cat(paste0("\\texttt{", item_name_code, "} &"))
  cat(paste0("\\textbf{", item_name, "}"))
  cat("\\newline \n")
  
  if (desc_left == FALSE) {
    cat(item_desc)
  }
  if (desc_left == TRUE) {
    cat("\\begin{flushleft}")
    cat(item_desc)
    cat("\n")
    cat("\\end{flushleft}")}
  cat("\n")
  cat("\\end{longtable}")
  
}

## taken from https://stackoverflow.com/a/69333730
fct_case_when <- function(...) {
  args <- as.list(match.call())
  levels <- sapply(args[-1], function(f) f[[3]])  # extract RHS of formula
  levels <- levels[!is.na(levels)]
  factor(dplyr::case_when(...), levels=levels)
}


```



## `link_polidoc_parties` and `link_polidoc_governments`

`link_polidoc_parties` and `link_polidoc_governments` provide easy links of either `ltw_election_results` or `ltw_election_results_and_gov`
with party manifestos and coalition agreements made available from polidoc.net - The Political Documents Archive.
While file names from polidoc.net follow a naming pattern
({partyID}.{stateID}.{year}.{1}.{number of party manifesto for election}), the provided links make joining the data easier.

Note that polidoc.net provides a manifesto for the Neue Liberale in the HB 2015 election (41441.005.2015.1.1). Since the party withdrew it's candidacy before the election and is thus not included in the election results in `ltw_election_results`, the manifesto id is not included in link_polidoc_parties.

Note that polidoc.net provides a coalition agreement between the SPD and the Greens following the 2008 HE election (41001.006.2008.1.1). Since this potential coalition under leadership of SPD politician Andrea Ypsilanti never came to be due to several SPD MPs opposing the red-green minority cabinet being externally supported by Die Linke the coalition agreement can't be matched with a government in `ltw_election_results_and_gov` and is thus not included.


\newpage

# Variables

```{r, results="asis"}
short_item(item_name_code = "state",
           item_name = "State Abbreviation",
           item_desc = "ISO 3166-2:DE-code of the state;
           including BA for the former state of Baden, WH for the former state
           of Württemberg-Hohenzollern and WB for the former state of
           Württemberg-Baden.",
           desc_left = FALSE)
```





```{r, results="asis"}
short_item(item_name_code = "election_date",
           item_name = "Election Date",
           item_desc = "Date of the election.  ISO 8601 or R-Date format.",
           desc_left = FALSE)

```



```{r, results="asis"}
item_start(item_name_code = "polidoc_filename and polidoc_filename_2 in link_polidoc_\nparties",
           item_name = "Polidoc File Name of Party Manifesto",
           item_desc = "File name of state party manifesto (or 2nd manifesto if available) available in The Political Documents Archive (polidoc.net).",
           desc_left = FALSE)

```


```{r, results="asis"}
top_pltpolidocparties <-
ltw_election_results %>% 
  left_join(link_polidoc_parties,
            by = c("state", "election_date", "partyname_short")) %>% 
  select(state, election_date, partyname_short, polidoc_filename, polidoc_filename_2) %>% 
  mutate(polidoc_filename = !is.na(polidoc_filename)) %>% 
  mutate(polidoc_filename_2 = !is.na(polidoc_filename_2)) %>% 
  group_by(state, election_date) %>% 
  summarise(
    number_of_manif = sum(polidoc_filename), 
    number_of_extra_manif = sum(polidoc_filename_2), .groups = "keep"
  ) %>% 
  ungroup() %>% 
  mutate(no_cat = fct_case_when(
    number_of_manif == 0 ~ "No manifesto\navailable",
    number_of_manif > 0 & number_of_extra_manif == 0 ~ "At least one\nmanifesto available",
    number_of_extra_manif > 0 ~ "At least one party with\ntwo available manifestos"
  )) %>% 
  mutate(number_of_manif_cat = fct_case_when(
    number_of_manif == 0 ~ "0",
    number_of_manif > 0 & number_of_manif <= 3 ~ "<= 3",
    number_of_manif > 3 & number_of_manif  <= 5 ~ "<= 5",
    number_of_manif > 5 ~ "> 5"
  )) %>% 
  ggplot(aes(x = election_date, y = state, shape = no_cat, col = number_of_manif_cat)) +
    geom_point(size = 4) +
    scale_color_brewer(type = "qual", palette = "Set1") +
    guides(shape = guide_legend(order = 1, nrow = 1),
           col = guide_legend(order = 2, nrow = 1)) +
    labs(x = "Election Date",
         y = NULL,
         shape = "",
         col = "No. of parties with at least one manifesto") +
    theme_minimal() +
    theme(legend.position = "bottom",
          legend.box = "vertical",
          axis.text.y = element_text(face = "bold", colour = "black"))


bot_pltpolidocparties <- 
ltw_election_results %>% 
  left_join(link_polidoc_parties,
            by = c("state", "election_date", "partyname_short")) %>% 
  mutate(manif_avail = !is.na(polidoc_filename)) %>% 
  select(state, election_date, partyname_short, manif_avail, party_vshare) %>% 
  mutate(grp = paste0(as.character(election_date), "~~~",state)) %>% 
  select(grp, partyname_short, manif_avail, party_vshare) %>% 
  group_by(grp) %>% 
  mutate(n_parties_running = n()) %>% 
  group_by(grp, manif_avail, n_parties_running) %>% 
  summarise(n_avail_cat = n(),
            sum_vshare_cat = sum(party_vshare), .groups = "keep") %>% 
  ungroup() %>% 
  complete(grp, manif_avail) %>% 
  group_by(grp) %>% 
  fill(n_parties_running, .direction = "downup") %>% 
  ungroup() %>% 
  filter(manif_avail == TRUE) %>% 
  mutate(n_avail_cat = ifelse(is.na(n_avail_cat), 0, n_avail_cat),
         sum_vshare_cat = ifelse(is.na(sum_vshare_cat), 0, sum_vshare_cat)) %>% 
  mutate(share_of_running_parties = n_avail_cat / n_parties_running) %>% 
  separate(grp, into = c("election_date", "state"), sep = "~~~") %>% 
  mutate(election_date = as.Date(election_date)) %>% 
  select(election_date, sum_vshare_cat, share_of_running_parties) %>% 
  pivot_longer(cols = c(sum_vshare_cat, share_of_running_parties)) %>% 
  mutate(name = case_when(
    name == "share_of_running_parties" ~ "Share of parties running",
    name == "sum_vshare_cat" ~ "Voteshare of parties with available manifesto"
  )) %>% 
  ggplot(aes(x = election_date, y = value)) +
    geom_point() +
    facet_wrap(~name) +
    scale_y_continuous(labels = scales::percent) +
    theme_minimal() +
    theme(strip.text = element_text(face = "bold")) +
    labs(x = NULL, y = NULL)


pltpolidocparties <- 
wrap_plots(top_pltpolidocparties,
           bot_pltpolidocparties,
           ncol = 1,
           heights = c(2,1))





item_image(ggobj = pltpolidocparties,
           filenameimg = "cbpolidoc/pltpolidocparties.pdf",
           width = 7,
           height = 9)

```

```{r, results="asis"}
item_end()
```




```{r, results="asis"}
item_start(item_name_code = "polidoc_filename in link_polidoc_\ngovernments",
           item_name = "Polidoc File Name of Coalition Agreement",
           item_desc = "File name of coalition agreement available in The Political Documents Archive (polidoc.net).",
           desc_left = FALSE)

```


```{r, results="asis"}
pltpolidocgov <-
ltw_election_results_and_gov %>% 
  left_join(
    link_polidoc_governments,
    by = c("state", "election_date", "gov_id")
  ) %>% 
  mutate(coalagreement_avail = !is.na(polidoc_filename)) %>% 
  select(state, election_date, gov_id, gov_start_date, coalagreement_avail) %>%
  distinct() %>% 
  arrange(state, gov_start_date) %>% 
  group_by(state) %>% 
  mutate(gov_end_date = lead(gov_start_date)) %>% 
  ungroup() %>% 
  mutate(gov_end_date = case_when(
    is.na(gov_end_date) & state %in% c("BA", "WH", "WB") ~ ltw_election_results %>% 
                                                            select(state, election_date) %>% 
                                                            filter(state == "BW") %>% 
                                                            filter(election_date == min(election_date)) %>% 
                                                            distinct() %>%
                                                            pull(election_date),
    is.na(gov_end_date) & !(state %in% c("BA", "WH", "WB")) ~ Sys.Date(),
    TRUE ~ gov_end_date
  )) %>% 
  ggplot() +
    geom_segment(aes(x = gov_start_date, xend = gov_end_date,
                     y = state, yend = state,
                     col = coalagreement_avail),
                 size = 5) +
    geom_segment(aes(x = gov_start_date, xend = gov_start_date + lubridate::duration(4, units = "weeks"),
                     y = state, yend = state),
                 col = "white",
                 size = 5) +
    geom_segment(
      data = ltw_election_results %>%
              select(state, election_date) %>%
              distinct() %>% 
              mutate(xend = election_date + lubridate::duration(4, units = "weeks")),
      aes(x = election_date, xend = xend,
          y = state, yend = state),
      size = 5,
      col = "black"
    ) +
  scale_color_manual(values = c("grey", "#4dae49")) +
    theme_minimal() +
    theme(legend.position = "bottom",
          plot.caption = element_text(hjust = 0)) +
    labs(x = NULL, y = NULL, col = "Coalition Agreement Available",
         caption = "Black vertical bars mark election dates. White vertical bars mark start date of government.")


item_image(ggobj = pltpolidocgov,
           filenameimg = "cbpolidoc/pltpolidocgov.pdf",
           width = 7,
           height = 5)


```




```{r, results="asis"}
item_end()
```



